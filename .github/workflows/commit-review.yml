name: Commit Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Allows manual trigger from Actions tab

jobs:
  review-commits:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR commits and review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e
          
          # Get the base and head refs
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Get commit messages
          echo "=== Fetching commits ==="
          COMMITS=$(git log --pretty=format:"- %s" "$BASE_SHA".."$HEAD_SHA")
          COMMIT_COUNT=$(git rev-list --count "$BASE_SHA".."$HEAD_SHA")
          
          echo "Found $COMMIT_COUNT commit(s):"
          echo "$COMMITS"
          
          # Get the diff
          echo "=== Fetching diff ==="
          DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" | head -c 50000)  # Limit diff size
          
          # Read the styleguide
          STYLEGUIDE=$(cat .gemini/styleguide.md)
          
          # Build the prompt
          PROMPT="$STYLEGUIDE

---

## PR Information

**Number of commits in this PR: $COMMIT_COUNT**

### Commit messages:
$COMMITS

### Code diff:
\`\`\`diff
$DIFF
\`\`\`

Please review this PR according to the guidelines above."

          # Call Gemini API
          echo "=== Calling Gemini API ==="
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --arg prompt "$PROMPT" '{contents: [{parts: [{text: $prompt}]}]}')")
          
          # Extract the text response
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not get response from Gemini API"')
          
          echo "=== Gemini Response ==="
          echo "$REVIEW_COMMENT"
          
          # Post comment to PR
          echo "=== Posting comment to PR ==="
          gh pr comment "$PR_NUMBER" --body "## Commit Review

$REVIEW_COMMENT

---
<sub>ðŸ¤– Automated review by Gemini</sub>"
