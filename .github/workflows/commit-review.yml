name: Commit Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  review-commits:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR commits and review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          
          # Determine PR number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            PR_INFO=$(gh pr view "$PR_NUMBER" --json baseRefOid,headRefOid)
            BASE_SHA=$(echo "$PR_INFO" | jq -r '.baseRefOid')
            HEAD_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi
          
          echo "Reviewing PR #$PR_NUMBER"
          
          # Fetch commits
          git fetch origin "$HEAD_SHA" --depth=100 2>/dev/null || true
          
          COMMITS=$(git log --pretty=format:"- %s" "$BASE_SHA".."$HEAD_SHA")
          COMMIT_COUNT=$(git rev-list --count "$BASE_SHA".."$HEAD_SHA")
          
          echo "Found $COMMIT_COUNT commit(s)"
          echo "$COMMITS"
          
          # Get diff (limited)
          DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" | head -c 50000)
          
          # Read styleguide
          STYLEGUIDE=$(cat .gemini/styleguide.md)
          
          # Build prompt and save to file to avoid escaping issues
          cat > /tmp/prompt.txt << PROMPT_END
          $STYLEGUIDE
          
          ---
          
          ## PR Information
          
          **Number of commits in this PR: $COMMIT_COUNT**
          
          ### Commit messages:
          $COMMITS
          
          ### Code diff:
          $DIFF
          
          Please review this PR according to the guidelines above.
          PROMPT_END
          
          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --rawfile prompt /tmp/prompt.txt '{contents: [{parts: [{text: $prompt}]}]}')")
          
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not get response from Gemini API"')
          
          echo "=== Gemini Response ==="
          echo "$REVIEW_COMMENT"
          
          # Save comment to file and post
          echo "$REVIEW_COMMENT" > /tmp/review.txt
          printf '## Commit Review\n\n%s\n\n---\n<sub>ðŸ¤– Automated review by Gemini</sub>' "$(cat /tmp/review.txt)" > /tmp/comment.txt
          gh pr comment "$PR_NUMBER" --body-file /tmp/comment.txt