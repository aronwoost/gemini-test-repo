name: Commit Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  review-commits:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR commits and review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          
          # Determine PR number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            PR_INFO=$(gh pr view "$PR_NUMBER" --json baseRefOid,headRefOid)
            BASE_SHA=$(echo "$PR_INFO" | jq -r '.baseRefOid')
            HEAD_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi
          
          echo "Reviewing PR #$PR_NUMBER"
          
          # Fetch commits
          git fetch origin "$HEAD_SHA" --depth=100 2>/dev/null || true
          
          COMMITS=$(git log --pretty=format:"- %s" "$BASE_SHA".."$HEAD_SHA")
          COMMIT_COUNT=$(git rev-list --count "$BASE_SHA".."$HEAD_SHA")
          
          echo "Found $COMMIT_COUNT commit(s)"
          echo "$COMMITS"
          
          # Get diff (limited)
          DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" | head -c 50000)
          
          # Read styleguide
          STYLEGUIDE=$(cat .gemini/styleguide.md)
          
          # Build prompt and save to file to avoid escaping issues
          cat > /tmp/prompt.txt << PROMPT_END
          $STYLEGUIDE
          
          ---
          
          ## PR Information
          
          **Number of commits in this PR: $COMMIT_COUNT**
          
          ### Commit messages:
          $COMMITS
          
          ### Code diff:
          $DIFF
          
          Please review this PR according to the guidelines above.
          PROMPT_END
          
          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=$GEMINI_API_KEY" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n --rawfile prompt /tmp/prompt.txt '{contents: [{parts: [{text: $prompt}]}]}')")
          
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "Error: Could not get response from Gemini API"')
          
          echo "=== Gemini Response ==="
          echo "$REVIEW_COMMENT"
          
          # Build comment with unique marker for identification
          COMMENT_MARKER="<!-- gemini-commit-review -->"
          printf '%s\n## üßë‚Äçüíª Commit Review\n\n%s' "$COMMENT_MARKER" "$REVIEW_COMMENT" > /tmp/comment.txt
          
          # Find existing comment by marker
          EXISTING_COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("<!-- gemini-commit-review -->")) | .id' | head -1)
          
          if [ -n "$EXISTING_COMMENT_ID" ]; then
            echo "Updating existing comment $EXISTING_COMMENT_ID"
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -X PATCH \
              -F body=@/tmp/comment.txt
          else
            echo "Creating new comment"
            gh pr comment "$PR_NUMBER" --body-file /tmp/comment.txt
          fi
          
          # Add labels based on review result
          echo "=== Label Management ==="
          echo "Review comment (first 500 chars):"
          echo "$REVIEW_COMMENT" | head -c 500
          echo ""
          echo "---"
          echo "Checking review comment for label decision..."
          if echo "$REVIEW_COMMENT" | grep -F "‚úÖ PR aligns with commit rules" >/dev/null 2>&1; then
            echo "‚úÖ Detected: PR aligns - removing squash-merge label if present"
            gh pr edit "$PR_NUMBER" --remove-label "squash-merge" 2>/dev/null || true
            echo "Label removal attempted"
          elif echo "$REVIEW_COMMENT" | grep -F "üóúÔ∏è PR does not align" >/dev/null 2>&1; then
            echo "üóúÔ∏è Detected: PR does not align - adding squash-merge label"
            gh pr edit "$PR_NUMBER" --add-label "squash-merge"
            echo "Label addition completed"
          elif echo "$REVIEW_COMMENT" | grep -F "üóúÔ∏è PR has one commit" >/dev/null 2>&1; then
            echo "üóúÔ∏è Detected: PR has one commit - adding squash-merge label"
            gh pr edit "$PR_NUMBER" --add-label "squash-merge"
            echo "Label addition completed"
          else
            echo "‚ö†Ô∏è No matching pattern found in review comment"
          fi
          echo "=== Label Management Complete ==="