name: Commit Review

# test

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: string

jobs:
  review-commits:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR commits and review
        env:
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          AZURE_OPENAI_MODEL: ${{ secrets.AZURE_OPENAI_MODEL }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          
          # Determine PR number
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            PR_INFO=$(gh pr view "$PR_NUMBER" --json baseRefOid,headRefOid)
            BASE_SHA=$(echo "$PR_INFO" | jq -r '.baseRefOid')
            HEAD_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')
          else
            PR_NUMBER="${{ github.event.pull_request.number }}"
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi
          
          echo "Reviewing PR #$PR_NUMBER"
          
          # Fetch commits
          git fetch origin "$HEAD_SHA" --depth=100 2>/dev/null || true
          
          COMMITS=$(git log --pretty=format:"- %s" "$BASE_SHA".."$HEAD_SHA")
          COMMIT_COUNT=$(git rev-list --count "$BASE_SHA".."$HEAD_SHA")
          
          echo "Found $COMMIT_COUNT commit(s)"
          echo "$COMMITS"
          
          # Get diff (limited)
          DIFF=$(git diff "$BASE_SHA".."$HEAD_SHA" | head -c 50000)
          
          # Read styleguide
          STYLEGUIDE=$(cat .github/commit-review-prompt.md)
          
          # Build prompt and save to file to avoid escaping issues
          cat > /tmp/prompt.txt << PROMPT_END
          $STYLEGUIDE
          
          ---
          
          ## PR Information
          
          **Number of commits in this PR: $COMMIT_COUNT**
          
          ### Commit messages:
          $COMMITS
          
          ### Code diff:
          $DIFF
          
          Please review this PR according to the guidelines above.
          PROMPT_END
          
          # Call Azure OpenAI Responses API
          PROMPT_TEXT=$(cat /tmp/prompt.txt)
          
          RESPONSE=$(curl -s "https://eastus.api.cognitive.microsoft.com/openai/responses?api-version=2025-04-01-preview" \
            -H 'Content-Type: application/json' \
            -H "api-key: $AZURE_OPENAI_KEY" \
            -d "$(jq -n --arg prompt "$PROMPT_TEXT" --arg model "$AZURE_OPENAI_MODEL" '{model: $model, input: $prompt}')")
          
          # Extract text from Responses API format: output[].content[].text
          REVIEW_COMMENT=$(echo "$RESPONSE" | jq -r '
            if .output then
              [.output[] | select(.type == "message") | .content[] | select(.type == "output_text") | .text] | join("\n")
            elif .error then
              "Error: " + .error.message
            else
              "Error: Could not get response from Azure OpenAI API"
            end
          ')
          echo "=== Azure OpenAI Response ==="
          echo "$REVIEW_COMMENT"
          
          # Build comment with unique marker for identification
          COMMENT_MARKER="<!-- azure-commit-review -->"
          printf '%s\n## ðŸ§‘â€ðŸ’» Commit Review\n\n%s' "$COMMENT_MARKER" "$REVIEW_COMMENT" > /tmp/comment.txt
          
          # Find existing comment by marker
          EXISTING_COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.body | startswith("<!-- azure-commit-review -->")) | .id' | head -1)
          
          if [ -n "$EXISTING_COMMENT_ID" ]; then
            echo "Updating existing comment $EXISTING_COMMENT_ID"
            gh api "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -X PATCH \
              -F body=@/tmp/comment.txt \
              --silent
          else
            echo "Creating new comment"
            gh pr comment "$PR_NUMBER" --body-file /tmp/comment.txt
          fi
          
          # Add labels based on review result
          if echo "$REVIEW_COMMENT" | grep -F "âœ… PR aligns with commit rules" >/dev/null 2>&1; then
            gh pr edit "$PR_NUMBER" --remove-label "squash-merge" 2>/dev/null || true
          elif echo "$REVIEW_COMMENT" | grep -F "ðŸ—œï¸ PR does not align" >/dev/null 2>&1; then
            gh pr edit "$PR_NUMBER" --add-label "squash-merge"
          elif echo "$REVIEW_COMMENT" | grep -F "ðŸ—œï¸ PR has one commit" >/dev/null 2>&1; then
            gh pr edit "$PR_NUMBER" --add-label "squash-merge"
          fi